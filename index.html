<!DOCTYPE HTML>
<style>
  pre {
    white-space: pre-wrap;
  }

  .tabs {
    display: block;
    min-height: 20em;
  }

  .tabs > nav {
    border-bottom: 1px gray solid;
  }

  .tabs > nav > a {
    display: inline-block;
    margin: 0 .2em;
    color: inherit;
    text-decoration: none;
  }

  .tabs > nav > a.active {
    padding-bottom: .2em;
    border-bottom: 2px solid;
    font-weight: bolder;
  }

  .tabs > .tab-sections > section {
    display: none;
  }

  .tabs > .tab-sections > section.active {
    display: block;
  }
</style>

<div id=edit-tabs class=tabs>
  <nav></nav>
  <div id=edit-tab-sections class=tab-sections></div>
</div>
<script>
  function updateTabs () {
    var tabs = document.querySelector ('#edit-tabs');
    var tabButtons = tabs.querySelector ('nav');
    var tabSections = Array.prototype.slice.call
        (tabs.querySelectorAll ('#edit-tab-sections > section'));
    tabButtons.textContent = '';
    tabSections.forEach (function (section) {
      var header = section.querySelector ('h1');
      var button = document.createElement ('a');
      button.href = '#' + section.id;
      button.textContent = header ? header.textContent : 'Section';
      button.className = section.className;
      tabButtons.appendChild (button);
    });
  } // updateTabs

  function selectTab (section) {
    var tabs = document.querySelector ('#edit-tabs');
    var tabSections = Array.prototype.slice.call
        (tabs.querySelectorAll ('#edit-tab-sections > section'));
    tabSections.forEach (function (section) {
      section.classList.remove ('active');
    });
    section.classList.add ('active');
  } // selectTab
</script>

<template id=source-template>
  <h1>Source <code class=source_id></code></h1>
  <progress class=status></progress>
  <p><textarea name=fetch_options></textarea>
  <p><textarea name=schedule_options></textarea>
</template>

<template id=process-template>
  <h1>Process <code class=process_id></code></h1>
  <progress class=status></progress>
  <p><textarea name=process_options></textarea>
  <p>Input:
  <ul class=input_source_ids-list></ul>
  <template class=input_source_id-template>
    <a href="" class=source_id-link>Source <code class=source_id></code></a>
  </template>
</template>

<script>
  function loadSource (sourceId) {
    var section = document.getElementById ('source/' + sourceId);
    if (section) {
      selectTab (section);
      updateTabs ();
      return;
    }

    var template = document.querySelector ('#source-template');
    section = document.createElement ('section');
    section.appendChild (template.content.cloneNode (true));
    section.id = 'source/' + sourceId;

    Array.prototype.forEach.call (section.querySelectorAll ('.source_id'), function (el) {
      el.textContent = sourceId;
    });

    var tabs = document.querySelector ('#edit-tab-sections');
    tabs.appendChild (section);

    var progress = section.querySelector ('.status');
    progress.hidden = false;

    fetch ('/source/' + encodeURIComponent (sourceId)).then (function (res) {
      return res.json ();
    }).then (function (json) {
      Array.prototype.forEach.call (section.querySelectorAll ('[name=fetch_options]'), function (el) {
        el.value = JSON.stringify (json.fetch.fetch_options);
      });
      Array.prototype.forEach.call (section.querySelectorAll ('[name=schedule_options]'), function (el) {
        el.value = JSON.stringify (json.fetch.schedule_options);
      });
      progress.hidden = true;
    });

    selectTab (section);
    updateTabs ();
    section.scrollIntoViewIfNeeded (true);
  } // loadSource

  function loadProcess (processId) {
    var section = document.getElementById ('process/' + processId);
    if (section) {
      selectTab (section);
      updateTabs ();
      return;
    }

    var template = document.querySelector ('#process-template');
    section = document.createElement ('section');
    section.appendChild (template.content.cloneNode (true));
    section.id = 'process/' + processId;

    Array.prototype.forEach.call (section.querySelectorAll ('.process_id'), function (el) {
      el.textContent = processId;
    });

    var tabs = document.querySelector ('#edit-tab-sections');
    tabs.appendChild (section);

    var progress = section.querySelector ('.status');
    progress.hidden = false;

    fetch ('/process/' + encodeURIComponent (processId)).then (function (res) {
      return res.json ();
    }).then (function (json) {
      Array.prototype.forEach.call (section.querySelectorAll ('[name=process_options]'), function (el) {
        el.value = JSON.stringify (json);
      });

      if (json.process_options &&
          json.process_options.input_source_ids &&
          json.process_options.input_source_ids.forEach) {
        var template = section.querySelector ('.input_source_id-template');
        var list = section.querySelector ('.input_source_ids-list');
        json.process_options.input_source_ids.forEach (function (sourceId) {
          var li = document.createElement ('li');
          li.appendChild (template.content.cloneNode (true));
          Array.prototype.forEach.call (li.querySelectorAll ('.source_id'), function (el) {
            el.textContent = sourceId;
          });
          Array.prototype.forEach.call (li.querySelectorAll ('.source_id-link'), function (el) {
            el.href = '#source/' + sourceId;
          });
          list.appendChild (li);
        });
      }

      progress.hidden = true;
    });

    selectTab (section);
    updateTabs ();
    section.scrollIntoViewIfNeeded (true);
  } // loadProcess
</script>

<script>
  function subscribe (url, onitem) {
    _subscribeURL (url, onitem);
  } // subscribe

  function _subscribeURL (url, onitem) {
    return fetch (url).then (function (res) {
      return res.json ();
    }).then (function (json) {
      var nextURL = json.next_url || url;
      var items = json.items;
      items.forEach (function (_) { onitem (_) });
      setTimeout (function () {
        _subscribeURL (nextURL, onitem);
      }, 30*1000);
    }, function (error) {
      addLog ({error: {message: error}});
      setTimeout (function () {
        _subscribeURL (nextURL, onitem);
      }, 30*1000);
    });
  } // _subscribeURL
</script>

<ul id=logs></ul>
<template id=log-template>
  <a href class=source_id-link>Source <span class=source_id></span></a>
  <a href class=process_id-link>Process <span class=process_id></span></a>
  <time class=timestamp></time>
  <pre class=bare></pre>
</template>

<script>
  function addLog (item) {
    var ul = document.querySelector ('#logs');
    var template = document.querySelector ('#log-template');
    var li = document.createElement ('li');
    li.appendChild (template.content.cloneNode (true));

    li.querySelector ('.bare').textContent = JSON.stringify (item);

    var time = li.querySelector ('.timestamp');
    var t = item.timestamp ? new Date (item.timestamp * 1000) : new Date;
    time.dateTime = t.toISOString ();
    time.textContent = t.toLocaleString ();

    Array.prototype.forEach.call (li.querySelectorAll ('.source_id'), function (el) {
      if (item.source_id) {
        el.textContent = item.source_id;
      } else {
        el.hidden = true;
      }
    });
    Array.prototype.forEach.call (li.querySelectorAll ('.source_id-link'), function (el) {
      if (item.source_id) {
        el.href = '#source/' + item.source_id;
      } else {
        el.hidden = true;
      }
    });

    Array.prototype.forEach.call (li.querySelectorAll ('.process_id'), function (el) {
      if (item.process_id) {
        el.textContent = item.process_id;
      } else {
        el.hidden = true;
      }
    });
    Array.prototype.forEach.call (li.querySelectorAll ('.process_id-link'), function (el) {
      if (item.process_id) {
        el.href = '#process/' + item.process_id;
      } else {
        el.hidden = true;
      }
    });

    ul.insertBefore (li, ul.firstChild);
    if (ul.children.length > 100) {
      ul.removeChild (ul.lastChild);
    }
  } // addLog

  subscribe ('/process/logs', addLog);
  subscribe ('/source/logs', addLog);
</script>

<script>
  var f = function () {
    location.hash.replace (/^#/, '').split (/,/).forEach (function (p) {
      var path = p.split (/\//);
      if (path.length === 2 && path[0] === 'source') {
        loadSource (path[1]);
      } else if (path.length === 2 && path[0] === 'process') {
        loadProcess (path[1]);
      } else {
        addLog ({error: {message: "Bad path", path: p}});
      }
    });
  }; // f
  onhashchange = f;
  f ();
</script>
